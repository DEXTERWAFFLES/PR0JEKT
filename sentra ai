import os
import streamlit as st
import google.generativeai as genai

# Load API key from environment variable
API_KEY = os.getenv("GEMINI_API_KEY")

if not API_KEY:
    st.error("âŒ Gemini API key not found! Please add it in Hugging Face 'Secrets'.")
else:
    genai.configure(api_key=API_KEY)

# âœ… Define Gemini model with system instructions
model = genai.GenerativeModel(
    "gemini-1.5-flash",
    system_instruction = (
    "You are Sentra AI, a gentle, kind, and empathetic Sleep Assistant chatbot. "
    "Your purpose is to support users emotionally, help them improve sleep quality, "
    "understand sleep habits, manage stress and sleep-related anxiety, and provide wellness guidance. "
    
    "Guidelines for responses:\n"
    "1. Always be extremely kind, warm, and supportive. "
    "Acknowledge feelings and provide reassurance before giving advice.\n"
    "2. Keep answers concise and conversational:\n"
    "   - General questions about sleep health: 2 lines max.\n"
    "   - 'How-to' or improvement questions: 5-6 lines max.\n"
    "3. Always ask a follow-up question to better understand the user's needs, feelings, or preferences.\n"
    "4. Use comforting language, gentle tone, and empathy. For example, use phrases like:\n"
    "   - 'I understand how you feel.'\n"
    "   - 'Many people feel this way, and itâ€™s okay.'\n"
    "   - 'Letâ€™s try a small step together.'\n"
    "5. Include relatable examples or simple suggestions when possible.\n"
    "6. If the user wants a detailed approach, provide step-by-step, actionable guidance in a gentle, supportive way.\n"
    "7. Never provide medical diagnoses. Include disclaimers when necessary.\n"
    "8. Avoid unrelated topics like math, coding, or politics.\n"
    "9. Emojis can be used sparingly to add warmth (e.g., ğŸ˜´, ğŸŒ™, ğŸŒ¼).\n"
    
    "Example behaviors:\n"
    "- User: 'I can't sleep at night.'\n"
    "  AI: 'I hear you ğŸ˜”. Sleepless nights can be tough. "
    "Have you tried dimming lights and taking deep breaths before bed? Would you like me to guide you through a relaxing bedtime routine?'\n"
    "- User: 'How can I sleep better?'\n"
    "  AI: 'Letâ€™s try small steps together ğŸŒ™. Avoid screens 30 mins before bed and keep your room cool. "
    "Do you want a full nightly routine to improve your sleep quality?'\n"
    
    "Remember: Keep responses short, kind, empathetic, and always gently guide the user for next input."
    )

)

# Streamlit UI
st.set_page_config(page_title="Sentra AI", page_icon="ğŸ˜´", layout="centered")

st.title("ğŸ˜´ Sentra AI")
st.markdown("Hello! I'm your AI-powered **Sleep Coach**. Ask me anything about sleep habits, bedtime routines, or tips for better rest!")

# âœ… Disclaimer right under description
st.markdown(
    """
    <div style="font-size:13px; color: #ffcc00; margin-top: -10px; margin-bottom: 15px;">
        âš ï¸ <b>Disclaimer:</b> Sentra AI is not a medical professional.  
        For serious health concerns, please consult a doctor.
    </div>
    """,
    unsafe_allow_html=True
)

# -------------------------
# Session state management
# -------------------------
if "messages" not in st.session_state:
    st.session_state.messages = []
    # âœ… Add greeting as first assistant message
    st.session_state.messages.append({
        "role": "assistant",
        "content": "Hello there! How can I help you rest easy tonight? "
                   "Is there anything on your mind, or are you just looking for some calming conversation before bed?"
    })

# -------------------------
# Display past chat messages
# -------------------------
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.markdown(msg["content"])

# -------------------------
# User input + AI response
# -------------------------
if prompt := st.chat_input("Type your question about sleep here..."):
    # Add user message
    st.session_state.messages.append({"role": "user", "content": prompt})
    st.chat_message("user").markdown(prompt)

    # Generate AI response
    with st.spinner("Thinking..."):
        response = model.generate_content(prompt)
        reply = response.text

    # Add assistant reply
    st.session_state.messages.append({"role": "assistant", "content": reply})
    st.chat_message("assistant").markdown(reply)
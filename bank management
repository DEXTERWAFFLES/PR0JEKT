import mysql.connector
from decimal import Decimal

def get_connection():
    return mysql.connector.connect(host="localhost‚Äù,user="root",
password="yourpassword",# change to your MySQL password
database="bank_system")
def init_db():
    conn = get_connection()
    cur = conn.cursor()

     cur.execute(""‚ÄùCREATE TABLE IF NOT EXISTS customers (
        customer_id INT AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(100) NOT NULL,
        email VARCHAR(100) UNIQUE,
        phone VARCHAR(20))""")

    cur.execute("""
    CREATE TABLE IF NOT EXISTS accounts (
        account_id INT AUTO_INCREMENT PRIMARY KEY,
        customer_id INT,
        balance DECIMAL(15,2) DEFAULT 0,
        FOREIGN KEY (customer_id) REFERENCES customers(customer_id)
    )
    """)

    cur.execute("""
    CREATE TABLE IF NOT EXISTS transactions (
        transaction_id INT AUTO_INCREMENT PRIMARY KEY,
        account_id INT,
        type VARCHAR(20),
        amount DECIMAL(15,2),
        related_account INT,
        date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (account_id) REFERENCES accounts(account_id)
    )
    """)

    conn.commit()
    conn.close()
    print("‚úÖ Database initialized successfully.\n")

# ------------------ Bank Operations ------------------
def create_customer(name, email, phone):
    conn = get_connection()
    cur = conn.cursor()
    cur.execute("INSERT INTO customers (name, email, phone) VALUES (%s, %s, %s)", (name, email, phone))
    conn.commit()
    print(f"Customer '{name}' created successfully with ID {cur.lastrowid}\n")
    conn.close()

def open_account(customer_id, initial_balance=0):
    conn = get_connection()
    cur = conn.cursor()
    cur.execute("INSERT INTO accounts (customer_id, balance) VALUES (%s, %s)", (customer_id, initial_balance))
    conn.commit()
    print(f"Account created successfully with ID {cur.lastrowid} for Customer {customer_id}\n")
    conn.close()

def deposit(account_id, amount):
    conn = get_connection()
    cur = conn.cursor()
    try:
        cur.execute("START TRANSACTION")
        cur.execute("SELECT balance FROM accounts WHERE account_id=%s FOR UPDATE", (account_id,))
        row = cur.fetchone()
        if not row:
            print("‚ùå Account not found")
            return
        new_balance = Decimal(row[0]) + Decimal(amount)
        cur.execute("UPDATE accounts SET balance=%s WHERE account_id=%s", (new_balance, account_id))
        cur.execute("INSERT INTO transactions (account_id, type, amount) VALUES (%s, 'deposit', %s)",
                    (account_id, amount))
        conn.commit()
        print(f"‚úÖ Deposited {amount} successfully. New balance: {new_balance}\n")
    except Exception as e:
        conn.rollback()
        print("‚ùå Deposit failed:", e)
    finally:
        conn.close()

def withdraw(account_id, amount):
    conn = get_connection()
    cur = conn.cursor()
    try:
        cur.execute("START TRANSACTION")
        cur.execute("SELECT balance FROM accounts WHERE account_id=%s FOR UPDATE", (account_id,))
        row = cur.fetchone()
        if not row:
            print("‚ùå Account not found")
            return
        balance = Decimal(row[0])
        if balance < Decimal(amount):
            print("‚ùå Insufficient balance!")
            conn.rollback()
            return
        new_balance = balance - Decimal(amount)
        cur.execute("UPDATE accounts SET balance=%s WHERE account_id=%s", (new_balance, account_id))
        cur.execute("INSERT INTO transactions (account_id, type, amount) VALUES (%s, 'withdraw', %s)",
                    (account_id, amount))
        conn.commit()
        print(f"‚úÖ Withdrawal of {amount} successful. New balance: {new_balance}\n")
    except Exception as e:
        conn.rollback()
        print("‚ùå Withdrawal failed:", e)
    finally:
        conn.close()

def transfer(from_acc, to_acc, amount):
    conn = get_connection()
    cur = conn.cursor()
    try:
        cur.execute("START TRANSACTION")
        cur.execute("SELECT balance FROM accounts WHERE account_id=%s FOR UPDATE", (from_acc,))
        from_row = cur.fetchone()
        cur.execute("SELECT balance FROM accounts WHERE account_id=%s FOR UPDATE", (to_acc,))
        to_row = cur.fetchone()
        if not from_row or not to_row:
            print("‚ùå One or both accounts not found")
            conn.rollback()
            return
        if Decimal(from_row[0]) < Decimal(amount):
            print("‚ùå Insufficient funds in source account!")
            conn.rollback()
            return
        new_from = Decimal(from_row[0]) - Decimal(amount)
        new_to = Decimal(to_row[0]) + Decimal(amount)
        cur.execute("UPDATE accounts SET balance=%s WHERE account_id=%s", (new_from, from_acc))
        cur.execute("UPDATE accounts SET balance=%s WHERE account_id=%s", (new_to, to_acc))
        cur.execute("INSERT INTO transactions (account_id, type, amount, related_account) VALUES (%s, 'transfer_out', %s, %s)",
                    (from_acc, amount, to_acc))
        cur.execute("INSERT INTO transactions (account_id, type, amount, related_account) VALUES (%s, 'transfer_in', %s, %s)",
                    (to_acc, amount, from_acc))
        conn.commit()
        print(f"Transfer successful! {amount} moved from Account {from_acc} to {to_acc}\n")
    except Exception as e:
        conn.rollback()
        print("Transfer failed:", e)
    finally:
        conn.close()

def check_balance(account_id):
    conn = get_connection()
    cur = conn.cursor()
    cur.execute("SELECT balance FROM accounts WHERE account_id=%s", (account_id,))
    row = cur.fetchone()
    if row:
        print(f"Account {account_id} Balance: {row[0]}\n")
    else:
        print("Account not found\n")
    conn.close()

def show_transactions(account_id):
    conn = get_connection()
    cur = conn.cursor()
    cur.execute("SELECT type, amount, related_account, date FROM transactions WHERE account_id=%s ORDER BY date DESC", (account_id,))
    rows = cur.fetchall()
    print(f"üìú Transaction history for Account {account_id}:")
    for r in rows:
        print(r)
    print()
    conn.close()

# ------------------ Menu ------------------
def menu():
    while True:
        print("\n===== BANK MANAGEMENT SYSTEM =====")
        print("1. Create Customer")
        print("2. Open Account")
        print("3. Deposit")
        print("4. Withdraw")
        print("5. Transfer")
        print("6. Check Balance")
        print("7. View Transactions")
        print("8. Exit")

        choice = input("Enter choice: ")

        if choice == '1':
            name = input("Enter name: ")
            email = input("Enter email: ")
            phone = input("Enter phone: ")
            create_customer(name, email, phone)

        elif choice == '2':
            cid = input("Enter customer ID: ")
            bal = Decimal(input("Initial deposit: "))
            open_account(cid, bal)

        elif choice == '3':
            aid = input("Enter account ID: ")
            amt = Decimal(input("Enter amount: "))
            deposit(aid, amt)

        elif choice == '4':
            aid = input("Enter account ID: ")
            amt = Decimal(input("Enter amount: "))
            withdraw(aid, amt)

        elif choice == '5':
            a1 = input("From account ID: ")
            a2 = input("To account ID: ")
            amt = Decimal(input("Amount: "))
            transfer(a1, a2, amt)

        elif choice == '6':
            aid = input("Enter account ID: ")
            check_balance(aid)

        elif choice == '7':
            aid = input("Enter account ID: ")
            show_transactions(aid)

        elif choice == '8':
            print("üëã Exiting... Goodbye!")
            break
        else:
            print("‚ùå Invalid option!")

# ------------------ Main ------------------
if __name__ == "__main__":
    init_db()
    menu()
